#!/bin/sh

set -eu

shift

echo '    [36;1mFetching[0m dependencies' >&2
cargo fetch --locked || (cargo generate-lockfile && cargo fetch --locked)
echo '     [36;1mRunning[0m `cargo '"$@"'`' >&2
target_dir="$(cargo metadata --format-version 1 | jq -r .target_directory)"
mkdir -p "$target_dir"
bwrap --ro-bind / / --tmpfs /tmp --ro-bind "$(pwd)" "$(pwd)" --bind "$target_dir" "$target_dir" --dev /dev --tmpfs /run --unshare-net cargo "$@"
